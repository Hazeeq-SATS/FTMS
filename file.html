<!DOCTYPE html>
<html>
<head>
    <title>Bluetooth Device Connection Example with QR Code Scanning</title>
    <style>
        /* Styles for video and captured photo elements */
        #cameraPreview, #qrVideo {
            display: none;
            width: 320px;
            height: 240px;
        }
        #capturedPhoto {
            display: none;
            width: 320px;
            height: 240px;
        }
    </style>
</head>
<body>
    <div id="bluetoothContainer">
        <button id="connectButton">Connect to Bluetooth Device</button>
        <div id="deviceInfo"></div>
    </div>

    <div id="captureContainer">
        <button id="captureButton">Capture Temperature and Photo</button>
        <div id="temperatureValue"></div>
    </div>

    <div id="nfcContainer">
        <button id="scanButton">Scan NFC</button>
        <div id="nfcContent"></div>
    </div>

    <div id="cameraContainer">
        <video id="cameraPreview" autoplay></video>
        <img id="capturedPhoto" alt="Captured photo">
    </div>

    <!-- QR Code Scanning Section -->
    <div id="qrContainer">
        <button id="qrScanButton">Scan QR Code</button> <!-- QR Scan Button -->
        <div id="qrResult">QR code result will appear here</div>
    </div>

   <script>
        let globalCharacteristic;
        let stream = null; // To hold the stream globally

  // Function to connect to a device, now separated for reuse
  async function connectToDevice(device) {
    console.log('Device selected:', device.name);
    document.getElementById('deviceInfo').innerText = `Connecting to device: ${device.name}`;
    try {
      const server = await device.gatt.connect();
      device.addEventListener('gattserverdisconnected', onDisconnected);
      const service = await server.getPrimaryService('45544942-4c55-4554-4845-524db87ad700');
      const characteristic = await service.getCharacteristic('45544942-4c55-4554-4845-524db87ad701');
      globalCharacteristic = characteristic;
      console.log('Ready to receive temperature notifications');
      startVideoStream();
      document.getElementById('deviceInfo').innerText = `Connected to device: ${device.name}`;
    } catch (error) {
      console.error('Connection failed:', error);
      document.getElementById('deviceInfo').innerText = 'Connection failed. Please try again.';
    }
  }

  // Automatically try to reconnect to known devices on app launch
  window.addEventListener('load', async () => {
    const devices = await navigator.bluetooth.getDevices();
    const lastDeviceId = localStorage.getItem('lastDeviceId');
    const device = devices.find(d => d.id === lastDeviceId);
    if (device) {
      console.log('Attempting to reconnect to device:', device.name);
      await connectToDevice(device);
    } else {
      console.log('No previously connected device found or permission not granted.');
    }
  });

  function onDisconnected(event) {
    const device = event.target;
    console.log(`Device ${device.name} disconnected.`);
    alert(`Device ${device.name} disconnected. Attempting to reconnect...`);
    reconnectToDevice(device);
  }

// Function to attempt reconnection
async function reconnectToDevice(device) {
    if (window.confirm(`Device ${device.name} disconnected. Attempt reconnect?`)) {
        try {
            await connectToDevice(device);
            console.log(`Reconnected to ${device.name}`);
            document.getElementById('deviceInfo').innerText = `Reconnected to device: ${device.name}`;
        } catch (error) {
            console.error(`Reconnection failed: ${error}`);
            document.getElementById('deviceInfo').innerText = `Reconnection failed. Please try again.`;
        }
    }
}


        async function startVideoStream() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;
                video.style.display = 'block';
            } catch (error) {
                console.error('Error accessing the camera', error);
            }
        }

        document.getElementById('connectButton').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: '21057150 RayTemp Blue' }],
                    optionalServices: ['45544942-4c55-4554-4845-524db87ad700']
                });
                localStorage.setItem('lastDeviceId', device.id); // Save for reconnection
                await connectToDevice(device);
            } catch (error) {
                console.error('Error selecting device:', error);
            }
        });

        // Attempt to automatically reconnect to a previously connected device when the page loads
        window.addEventListener('load', async () => {
            const devices = await navigator.bluetooth.getDevices();
            const lastDeviceId = localStorage.getItem('lastDeviceId');
            const device = devices.find(d => d.id === lastDeviceId);
            if (device) {
                await connectToDevice(device);
            }
        });

        document.getElementById('captureButton').addEventListener('click', function() {
            if (globalCharacteristic) {
                globalCharacteristic.readValue().then(value => {
                    const temperature = value.getFloat32(0, true);
                    document.getElementById('temperatureValue').innerText = `Temperature: ${temperature}Â°C`;
                    capturePhoto();
                });
            }
        });

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert canvas to an image and display it
            const img = document.getElementById('capturedPhoto');
            img.src = canvas.toDataURL('image/png');
            img.style.display = 'block';

            // Hide the video element and stop the video stream
            video.style.display = 'none';
            if (stream) {
                let tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
            }
        }


        // NFC Scan Button Logic
        document.getElementById('scanButton').addEventListener("click", async () => {
            if ('NDEFReader' in window) {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    console.log("> Scan started");

                    ndef.addEventListener("readingerror", () => {
                        console.error("Argh! Cannot read data from the NFC tag. Try another one?");
                    });

                    ndef.addEventListener("reading", ({ message, serialNumber }) => {
                        console.log(`> Serial Number: ${serialNumber}`);
                        console.log(`> Records: (${message.records.length})`);

                        const nfcContentElement = document.getElementById('nfcContent');
                        let content = `Serial Number: ${serialNumber}<br>`;
                        message.records.forEach((record, index) => {
                            content += `Record ${index + 1}: `;
                            switch(record.recordType) {
                                case "text":
                                    const textDecoder = new TextDecoder(record.encoding);
                                    content += `Text: ${textDecoder.decode(record.data)}<br>`;
                                    break;
                                case "url":
                                    const urlDecoder = new TextDecoder();
                                    content += `URL: ${urlDecoder.decode(record.data)}<br>`;
                                    break;
                                // Add more case handlers as necessary for different record types
                            }
                        });
                        nfcContentElement.innerHTML = content;
                    });
                } catch (error) {
                    console.error("Argh! " + error);
                }
            } else {
                console.error("Web NFC is not supported.");
            }
        });
        
        // QR Code Scan Button Logic using the Barcode Detection API
        document.getElementById('qrScanButton').addEventListener('click', async () => {
            if ('BarcodeDetector' in window) {
                try {
                    const barcodeDetector = new BarcodeDetector({formats: ['qr_code']});
                    const videoElement = document.getElementById('cameraPreview');
                    videoElement.style.display = 'block'; // Show video element to start capturing video

                    // Use the video stream for QR code detection
                    if (!stream) {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                        videoElement.srcObject = stream;
                    }

                    // Continuously scan for QR codes
                    const scanQRCode = async () => {
                        try {
                            const barcodes = await barcodeDetector.detect(videoElement);
                            if (barcodes.length > 0) {
                                document.getElementById('qrResult').textContent = `QR Code Content: ${barcodes[0].rawValue}`;
                                // Stop the video stream as QR code is found
                                stream.getTracks().forEach(track => track.stop());
                                videoElement.style.display = 'none'; // Hide the video element
                            } else {
                                requestAnimationFrame(scanQRCode); // Keep scanning
                            }
                        } catch (error) {
                            console.error('QR scanning error:', error);
                        }
                    };
                    scanQRCode();
                } catch (error) {
                    console.error('Error initializing QR code scanning:', error);
                }
            } else {
                console.error('Barcode Detection API is not supported by this browser.');
                document.getElementById('qrResult').textContent = 'QR Code scanning is not supported by this browser.';
            }
        });

    </script>
</body>
</html>
